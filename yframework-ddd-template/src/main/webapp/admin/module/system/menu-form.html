<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
        &times;
    </button>
    <h4 class="modal-title">表单</h4>
</div>
<div class="modal-body no-padding">
    <form id="input-form" class="smart-form">
        <input type="hidden" name="id" class="form-param"/>
        <fieldset>
            <section>
                <div class="row">
                    <label class="label col col-2">父级菜单</label>
                    <div class="col col-10">
                        <label class="select"> <i class="icon-append fa fa-inbox"></i>
                            <select id="parent" name="parentId">
                            </select>
                        </label>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">菜单名</label>
                    <div class="col col-10">
                        <label class="input">
                            <input type="text" name="name" class="form-param"/>
                        </label>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">图标</label>
                    <div class="col col-10">
                        <label class="input"><i id="icon_show" class="icon-append fa fa-inbox"></i>
                            <input type="text" name="icon" class="form-param"
                                   onkeyup="onShowIcon(this);"/>
                        </label>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">地址</label>
                    <div class="col col-10">
                        <label class="input">
                            <input type="text" name="href" class="form-param"/>
                        </label>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">排序</label>
                    <div class="col col-10">
                        <label class="input">
                            <input type="number" name="sort" class="form-param"/>
                        </label>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">是否显示</label>
                    <div class="col col-10">
                        <label class="toggle">
                            <input type="checkbox" name="show"/>
                            <i style="right: auto; border-color: #3276B1;" data-swchon-text="ON"
                               data-swchoff-text="OFF"></i>
                        </label>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">权限</label>
                    <div class="col col-10">
                        <label class="input">
                            <input type="text" name="permission" class="form-param"/>
                        </label>
                    </div>
                </div>
            </section>
        </fieldset>
        <footer>
            <button type="submit" class="btn btn-primary">
                SUBMIT
            </button>
            <button type="button" class="btn btn-default" data-dismiss="modal">
                CANCEL
            </button>
        </footer>
    </form>
</div>
<script type="text/javascript">
    var api = _HOST + "mgt/menus";

    // common
    pageSetUp();

    function onInit() {
        var formId = "#input-form";
        var modal = mgt.form.modal.instance;
        var objId = mgt.form.modal.data("id");
        mgt.provider.queryMenus(onInitSelect);
        if (objId) {
            mgt.service.find(api, objId,
                function (res) {
                    $('input[name="show"]').prop('checked', res.show);
                    onSelect(res);
                    mgt.form.load(res);
                    onShowIcon();
                },
                function (res) {
                    dialog.error(res.description || res.message || '系统错误');
                }
            );
        }
        $(formId).validate({
            // Rules for form validation
            rules: {
                parentId: {
                    required: true
                },
                name: {
                    required: true
                },
                sort: {
                    required: true
                }
            },

            // Do not change code below
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            submitHandler: function () {  //通过之后回调
                modal.modal('hide');
                dialog.warn("确认要提交当前表单吗?", "提交表单", function () {
                    var params = mgt.form.get(formId);
                    params.show = !!params.show;
                    console.log(params);
                    onSubmit(params);
                    return false;
                }, function () {
                    modal.modal('show');
                });
            },
            invalidHandler: function () {  //不通过回调
                return false;
            }
        });
    }

    function onInitSelect(res) {
        var p = document.getElementById('parent');
        res.forEach(function (menu) {
            var option = document.createElement('option');
            option.id = 'child_' + menu.id;
            option.value = menu.id;
            option.innerHTML = menu.name;
            p.appendChild(option);
        });
    }

    function onSelect(obj) {
        var p = document.getElementById('parent');
        $('#child_' + obj.parentId).prop('selected', true);
        p.removeChild(document.getElementById('child_' + obj.id));
    }

    function onShowIcon(obj) {
        var className = 'icon-append ' + (obj ? obj.value : $('input[name="icon"].form-param').val());
        $('#icon_show').removeClass().addClass(className);
    }

    function onSubmit(params) {
        if (params && yutil.validator.isNotEmpty(params.id)) {
            //修改
            mgt.service.put(api, params,
                function (res) {
                    yutil.storage.remove(_KEY_MGT_MENUS + '_root');
                    yutil.storage.remove(_KEY_MGT_MENUS + '_account');
                    mgt.form.table.get(api).draw();
                }, function (res) {
                    dialog.error(res.description || res.message || '系统错误');
                }
            );
        }
        else {
            //新增
            mgt.service.post(api, params,
                function (res) {
                    yutil.storage.remove(_KEY_MGT_MENUS + '_root');
                    yutil.storage.remove(_KEY_MGT_MENUS + '_account');
                    yutil.storage.remove(_KEY_MGT_MENUS);
                    mgt.form.table.get(api).draw();
                }, function (res) {
                    dialog.error(res.description || res.message || '系统错误');
                }
            );
        }
    }

    onInit();
</script>