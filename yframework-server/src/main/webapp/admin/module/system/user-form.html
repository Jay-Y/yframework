<style>
    .dropzone {
        min-height: 180px;
    }
</style>
<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
        &times;
    </button>
    <h4 class="modal-title">表单</h4>
</div>
<div class="modal-body no-padding">
    <form id="input-form" class="smart-form">
        <input type="hidden" name="id" class="form-param"/>
        <input id="imageUrl" type="hidden" name="imageUrl" class="form-param">
        <fieldset>
            <section>
                <div class="row">
                    <label class="label col col-2">登录名</label>
                    <div class="col col-10">
                        <label class="input">
                            <input type="text" name="login" class="form-param">
                        </label>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">姓氏</label>
                    <div class="col col-10">
                        <label class="input">
                            <input type="text" name="firstName" class="form-param">
                        </label>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">名字</label>
                    <div class="col col-10">
                        <label class="input">
                            <input type="text" name="lastName" class="form-param">
                        </label>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">邮箱</label>
                    <div class="col col-10">
                        <label class="input">
                            <input type="email" name="email" class="form-param">
                        </label>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">角色</label>
                    <div class="col col-10">
                        <label class="select">
                            <select id="authorities" name="authorities" multiple>
                            </select>
                        </label>
                    </div>
                </div>
            </section>
            <section>
                <div class="row">
                    <label class="label col col-2">头像</label>
                    <div class="col col-5">
                        <p><i class="fa fa-cloud"></i>点击空白处上传图片</p>
                        <div id="form-dropzone" class="dropzone"></div>
                        <p class="note">上传新图片后，旧图片失效</p>
                    </div>
                </div>
            </section>

        </fieldset>
        <footer>
            <button type="submit" class="btn btn-primary">
                SUBMIT
            </button>
            <button type="button" class="btn btn-default" data-dismiss="modal">
                CANCEL
            </button>
        </footer>
    </form>
</div>
<script type="text/javascript">
    var api = _HOST + "mgt/users";

    // common
    pageSetUp();

    function onInit() {
        var formId = "#input-form";
        var modal = mgt.form.modal.instance;
        onInitDropzone();
        mgt.provider.queryRoles(onInitSelect);
        $(formId).validate({
            // Rules for form validation
            rules: {
                login: {
                    required: true
                },
                firstName: {
                    required: true
                },
                lastName: {
                    required: true
                },
                authorities: {
                    required: true
                }
            },

            // Messages for form validation
            messages: {
                login: {
                    required: 'Please enter login.'
                }
            },

            // Do not change code below
            errorPlacement: function (error, element) {
                error.insertAfter(element.parent());
            },
            submitHandler: function () {  //通过之后回调
                modal.modal('hide');
                dialog.warn("确认要提交当前表单吗?", "提交表单", function () {
                    var params = mgt.form.get(formId);
                    params.imageUrl = $("#imageUrl").val();
                    params.authorities = getMultiple(document.getElementById('authorities'));
                    onSubmit(params);
                    return false;
                }, function () {
                    modal.modal('show');
                });
            },
            invalidHandler: function () {  //不通过回调
                return false;
            }
        });
    }

    function onInitDropzone() {
//        var mockFiles = [];
//        if (yutil.validator.isNotEmpty(url)) {
//            var photo = {
//                name: url,
//                url: url,
//                accepted: true
//            };
//            mockFiles.push(photo);
//        }
        var idToken = yutil.storage.get('id_token');
        $("#form-dropzone").dropzone({
            url: _MGT_UPLOAD,
            headers: {
                'Client-Type': 'I',
                'Authorization': 'Bearer ' + idToken
            },
            maxFiles: 1,
            maxFilesize: 512,
            acceptedFiles: ".png,.jpg,.jpeg",
            addRemoveLinks: true,//添加移除文件
            dictMaxFilesExceeded: "您一次最多只能上传{{maxFiles}}个文件.",
            dictFileTooBig: "文件过大({{filesize}}MB),上传文件最大支持:{{maxFilesize}}MB.",
            dictDefaultMessage: '',
//            dictDefaultMessage: '<span class="text-center"><span class="font-lg visible-xs-block visible-sm-block visible-lg-block"><span class="font-lg"><i class="fa fa-caret-right text-danger"></i> Drop files <span class="font-xs">to upload</span></span><span>&nbsp&nbsp<h4 class="display-inline"> (Or Click)</h4></span>',
            dictResponseError: '文件上传失败!',
            dictInvalidFileType: "你不能上传该类型文件,文件类型只能是.png,.jpg,.jpeg.",
            dictRemoveFile: "移除文件",
            dictFallbackMessage: "当前浏览器版本过低,不支持上传.",
            uploadMultiple: false,
            init: function () {
//                for (var i in mockFiles) {
//                    var mockFile = mockFiles[i];
//                    this.emit('addedfile', mockFile);
//                    this.emit('thumbnail', mockFile, mockFile.url);
//                    this.emit('success', mockFile);
//                    this.emit('processing', mockFile);
//                    this.emit('complete', mockFile);
//                    this.files.push(mockFile);
//                }
                this.on("error", function (file, message) {
                    alert(message);
                    this.removeFile(file);
                });
                this.on("success", function (file, result) {
                    if (yutil.validator.isNotEmpty(result)) {
                        for (var i in result) {
                            var imageUrl = result[i].url;
                            $("#imageUrl").val(imageUrl);
                            file.name = imageUrl;
                            file.url = imageUrl;
                        }
                    }
                });
                this.on("removedfile", function (file) {
                    $("#imageUrl").val(null);
                });
            }
        });
    }

    function onInitSelect() {
        var p = document.getElementById('authorities');
        var roles = yutil.storage.get(_KEY_MGT_ROLES);
        roles = roles ? JSON.parse(roles) : [];
        roles.forEach(function (role) {
            var option = document.createElement('option');
            option.value = role.id;
            option.innerHTML = role.name;
            p.appendChild(option);
        });
        var objId = mgt.form.modal.data("id");
        if (yutil.validator.isNotEmpty(objId)) {
            mgt.service.find(api, objId,
                function (res) {
                    mgt.form.load(res);
                    onSelect(res.authorities);
                },
                function (res) {
                    dialog.error(res.description || res.message || '系统错误');
                }
            );
        }
    }

    function onSelect(authorities) {
        var options = document.getElementById('authorities').childNodes;
        options.forEach(function (option) {
            if (authorities && authorities.length > 0) {
                option.selected = (authorities.indexOf(option.value) != -1);
            }
        });
    }

    function onSubmit(params) {
        if (params && yutil.validator.isNotEmpty(params.id)) {
            //修改
            mgt.service.put(api, params,
                function (res) {
                    mgt.form.table.get(api).draw();
                }, function (res) {
                    dialog.error(res.description || res.message || '系统错误');
                }
            );
        }
        else {
            //新增
            mgt.service.post(api, params,
                function (res) {
                    mgt.form.table.get(api).draw();
                }, function (res) {
                    dialog.error(res.description || res.message || '系统错误');
                }
            );
        }
    }

    function getMultiple(obj) {
        var arr = [];
        var options = obj.options;

        while (obj.selectedIndex != -1) {
            arr.push(options[obj.selectedIndex].value);
            options[obj.selectedIndex].selected = false;
        }
        return arr;
    }

    loadScript(_LIB_PATH + "dropzone/dropzone.min.js", onInit);
</script>